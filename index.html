<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Retrieve">
  <meta name="theme-color" content="#0f172a">
  <title>RETRIEVE ‚Äî Training Tracker</title>
  
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlJFVFJJRVZFIFRyYWluaW5nIFRyYWNrZXIiLAogICJzaG9ydF9uYW1lIjogIlJldHJpZXZlIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwZjE3MmEiLAogICJ0aGVtZV9jb2xvciI6ICIjMGYxNzJhIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiCn0=">
  
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAgMTgwIj48cmVjdCB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgZmlsbD0iIzBmMTcyYSIvPjx0ZXh0IHg9IjkwIiB5PSIxMDUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI3MCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiMxMGI5ODEiIHRleHQtYW5jaG9yPSJtaWRkbGUiPlI8L3RleHQ+PC9zdmc+">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-green: #10b981;
      --accent-green-dark: #059669;
      --accent-blue: #3b82f6;
      --accent-red: #ef4444;
      --accent-yellow: #f59e0b;
      --border: #334155;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      overflow-x: hidden;
    }
    html { height: -webkit-fill-available; }
    
    .header {
      background: var(--bg-secondary);
      padding: 16px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid var(--border);
    }
    .header-content {
      max-width: 500px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-size: 22px;
      font-weight: 800;
      letter-spacing: -0.5px;
      color: var(--accent-green);
    }
    .sync-indicator {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .sync-indicator.syncing { color: var(--accent-yellow); }
    .sync-indicator.synced { color: var(--accent-green); }
    .sync-indicator.offline { color: var(--accent-red); }
    .sync-indicator.error { color: var(--accent-red); }
    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }
    .dot.pulse { animation: pulse 1s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    .date-nav {
      background: var(--bg-secondary);
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    .date-nav-content {
      max-width: 500px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .nav-btn {
      background: var(--bg-tertiary);
      border: none;
      color: var(--text-primary);
      width: 44px;
      height: 44px;
      border-radius: 12px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .nav-btn:active { background: var(--border); }
    .date-info { text-align: center; }
    .date-main { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
    .date-sub { font-size: 13px; color: var(--text-secondary); }
    .session-badge {
      display: inline-block;
      background: var(--bg-tertiary);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      margin-top: 6px;
      color: var(--accent-green);
      font-weight: 500;
    }
    
    .tabs {
      display: flex;
      max-width: 500px;
      margin: 0 auto;
      border-bottom: 1px solid var(--border);
      background: var(--bg-primary);
      position: sticky;
      top: 65px;
      z-index: 99;
    }
    .tab {
      flex: 1;
      padding: 14px 8px;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      background: none;
      border: none;
      cursor: pointer;
      position: relative;
      transition: color 0.2s;
    }
    .tab.active { color: var(--accent-green); }
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 20%;
      right: 20%;
      height: 3px;
      background: var(--accent-green);
      border-radius: 3px 3px 0 0;
    }
    
    .content {
      max-width: 500px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 100px;
    }
    .card {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .card-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }
    .input {
      width: 100%;
      background: var(--bg-tertiary);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 17px;
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s;
    }
    .input:focus { border-color: var(--accent-green); }
    .input::placeholder { color: var(--text-muted); }
    textarea.input {
      resize: none;
      min-height: 100px;
      font-family: inherit;
      line-height: 1.5;
    }
    
    .toggle-group { display: flex; gap: 10px; }
    .toggle-btn {
      flex: 1;
      padding: 16px;
      border-radius: 12px;
      border: 2px solid var(--bg-tertiary);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .toggle-btn.active-yes { background: var(--accent-green); border-color: var(--accent-green); }
    .toggle-btn.active-no { background: var(--accent-red); border-color: var(--accent-red); }
    
    .rating-group { display: flex; gap: 4px; }
    .rating-btn {
      flex: 1;
      padding: 12px 4px;
      border-radius: 8px;
      border: none;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .rating-btn.active { background: var(--accent-green); color: white; }
    .rating-btn.active-blue { background: var(--accent-blue); color: white; }
    
    .sessions-group { display: flex; gap: 6px; }
    .session-btn {
      flex: 1;
      padding: 14px 8px;
      border-radius: 10px;
      border: none;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .session-btn.active { background: var(--accent-green); color: white; }
    
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    
    .btn-primary {
      width: 100%;
      padding: 18px;
      border-radius: 14px;
      border: none;
      background: var(--accent-blue);
      color: white;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: background 0.2s;
      margin-top: 20px;
    }
    .btn-primary:active { background: #2563eb; }
    .btn-primary:disabled { background: var(--bg-tertiary); color: var(--text-muted); }
    
    .section-title {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
      padding-left: 4px;
    }
    
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      padding: 12px 20px;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
    }
    .footer-content {
      max-width: 500px;
      margin: 0 auto;
      text-align: center;
    }
    .target-text { font-size: 11px; color: var(--text-muted); }
    .target-highlight { color: var(--accent-green); font-weight: 600; }
    
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      padding: 14px 24px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      transition: all 0.3s;
      z-index: 200;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.success { background: var(--accent-green); }
    .toast.error { background: var(--accent-red); }
    
    .loading-screen {
      position: fixed;
      inset: 0;
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .loading-logo { font-size: 48px; font-weight: 800; color: var(--accent-green); margin-bottom: 20px; }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--bg-tertiary);
      border-top-color: var(--accent-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .loading-text { margin-top: 20px; color: var(--text-muted); font-size: 14px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .app-content { display: none; }
    .app-content.loaded { display: block; }
    
    .connection-banner {
      background: var(--accent-yellow);
      color: #000;
      text-align: center;
      padding: 8px;
      font-size: 12px;
      font-weight: 600;
      display: none;
    }
    .connection-banner.show { display: block; }
  </style>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">R</div>
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Connecting...</div>
  </div>

  <div class="app-content" id="appContent">
    <div class="connection-banner" id="connectionBanner">Offline ‚Äî changes will sync when connected</div>
    
    <header class="header">
      <div class="header-content">
        <div class="logo">RETRIEVE</div>
        <div class="sync-indicator" id="syncIndicator">
          <span class="dot" id="syncDot"></span>
          <span id="syncText">Synced</span>
        </div>
      </div>
    </header>

    <div class="date-nav">
      <div class="date-nav-content">
        <button class="nav-btn" id="prevDay">‚Üê</button>
        <div class="date-info">
          <div class="date-main" id="dateMain">MON ‚Äî Jan 6</div>
          <div class="date-sub" id="dateSub">Week 1</div>
          <div class="session-badge" id="sessionBadge">Upper A</div>
        </div>
        <button class="nav-btn" id="nextDay">‚Üí</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="daily">Daily</button>
      <button class="tab" data-tab="lifts">Lifts</button>
      <button class="tab" data-tab="weekly">Weekly</button>
      <button class="tab" data-tab="body">Body</button>
    </div>

    <div class="content">
      <div id="daily-tab" class="tab-content">
        <div class="card">
          <div class="card-label">Weight (kg)</div>
          <input type="number" step="0.1" class="input" id="weight" placeholder="77.3" inputmode="decimal">
        </div>
        <div class="card">
          <div class="card-label">Session Completed?</div>
          <div class="toggle-group">
            <button class="toggle-btn" id="sessionYes">‚úì Yes</button>
            <button class="toggle-btn" id="sessionNo">‚úó No</button>
          </div>
        </div>
        <div class="card">
          <div class="card-label">Protein (g)</div>
          <input type="number" class="input" id="protein" placeholder="145" inputmode="numeric">
        </div>
        <div class="card">
          <div class="card-label">Water (L)</div>
          <input type="number" step="0.5" class="input" id="water" placeholder="3.0" inputmode="decimal">
        </div>
        <div class="card">
          <div class="card-label">Sleep (hours)</div>
          <input type="number" step="0.5" class="input" id="sleep" placeholder="7.0" inputmode="decimal">
        </div>
        <div class="card">
          <div class="card-label">Nutrition (1-10)</div>
          <div class="rating-group" id="nutritionRating"></div>
        </div>
        <div class="card">
          <div class="card-label">Energy (1-10)</div>
          <div class="rating-group" id="energyRating"></div>
        </div>
        <div class="card" id="runningCard" style="display:none; border: 2px solid var(--accent-green);">
          <div class="card-label" style="color: var(--accent-green);">üèÉ Running</div>
          <div>
            <div class="card-label" style="font-size: 11px;">Time (min) *</div>
            <input type="number" class="input" id="runTime" placeholder="30" inputmode="numeric" style="margin-bottom: 12px;">
          </div>
          <div class="grid-2">
            <div>
              <div class="card-label" style="font-size: 11px;">Distance (km) ‚Äî optional</div>
              <input type="number" step="0.1" class="input" id="runDistance" placeholder="‚Äî" inputmode="decimal">
            </div>
            <div>
              <div class="card-label" style="font-size: 11px;">Pace (auto)</div>
              <div id="runPace" style="background: var(--bg-tertiary); padding: 14px 16px; border-radius: 12px; color: var(--accent-green); font-weight: 600; height: 49px; display: flex; align-items: center;">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-label">Notes</div>
          <textarea class="input" id="notes" placeholder="Any observations, issues, wins..."></textarea>
        </div>
      </div>

      <div id="lifts-tab" class="tab-content" style="display:none;">
        <div class="section-title">Week <span id="liftsWeek">1</span> ‚Äî Best sets (kg √ó reps)</div>
        <div class="card">
          <div class="card-label">Incline Bench Press</div>
          <input type="text" class="input" id="lift-incline" placeholder="60kg √ó 8">
        </div>
        <div class="card">
          <div class="card-label">Shoulder Press</div>
          <input type="text" class="input" id="lift-ohp" placeholder="40kg √ó 10">
        </div>
        <div class="card">
          <div class="card-label">Pull-ups</div>
          <input type="text" class="input" id="lift-pullups" placeholder="BW+5kg √ó 5">
        </div>
        <div class="card">
          <div class="card-label">Barbell Row</div>
          <input type="text" class="input" id="lift-row" placeholder="65kg √ó 10">
        </div>
        <div class="card">
          <div class="card-label">Back Squat</div>
          <input type="text" class="input" id="lift-squat" placeholder="80kg √ó 5">
        </div>
        <div class="card">
          <div class="card-label">Romanian Deadlift</div>
          <input type="text" class="input" id="lift-rdl" placeholder="70kg √ó 10">
        </div>
      </div>

      <div id="weekly-tab" class="tab-content" style="display:none;">
        <div class="section-title">Week <span id="weeklyWeek">1</span> Summary</div>
        <div class="card">
          <div class="card-label">Sessions Completed</div>
          <div class="sessions-group" id="sessionsGroup"></div>
        </div>
        <div class="grid-2">
          <div class="card">
            <div class="card-label">Start Weight (kg)</div>
            <input type="number" step="0.1" class="input" id="weekStartWeight" placeholder="77.3" inputmode="decimal">
          </div>
          <div class="card">
            <div class="card-label">End Weight (kg)</div>
            <input type="number" step="0.1" class="input" id="weekEndWeight" placeholder="76.8" inputmode="decimal">
          </div>
        </div>
        <div class="card">
          <div class="card-label">Average Sleep (hours)</div>
          <input type="number" step="0.5" class="input" id="weekAvgSleep" placeholder="6.5" inputmode="decimal">
        </div>
        <div class="card">
          <div class="card-label">Weekly Notes</div>
          <textarea class="input" id="weekNotes" placeholder="How did the week go? Issues? Adjustments needed?"></textarea>
        </div>
        <button class="btn-primary" id="downloadReport">üìÑ Download Week Report</button>
      </div>

      <div id="body-tab" class="tab-content" style="display:none;">
        <div class="section-title">Monthly Measurements ‚Äî <span id="bodyMonth">Jan</span></div>
        <div class="card">
          <div class="card-label">Weight (kg)</div>
          <input type="number" step="0.1" class="input" id="bodyWeight" placeholder="77.3" inputmode="decimal">
        </div>
        <div class="card">
          <div class="card-label">Waist (cm)</div>
          <input type="number" step="0.5" class="input" id="bodyWaist" placeholder="85" inputmode="decimal">
        </div>
        <div class="card">
          <div class="card-label">Shoulders (cm)</div>
          <input type="number" step="0.5" class="input" id="bodyShoulders" placeholder="115" inputmode="decimal">
        </div>
        <div class="card">
          <div class="card-label">Chest (cm)</div>
          <input type="number" step="0.5" class="input" id="bodyChest" placeholder="100" inputmode="decimal">
        </div>
        <div class="grid-2">
          <div class="card">
            <div class="card-label">Left Arm (cm)</div>
            <input type="number" step="0.5" class="input" id="bodyArmL" placeholder="35" inputmode="decimal">
          </div>
          <div class="card">
            <div class="card-label">Right Arm (cm)</div>
            <input type="number" step="0.5" class="input" id="bodyArmR" placeholder="35" inputmode="decimal">
          </div>
        </div>
      </div>
    </div>

    <footer class="footer">
      <div class="footer-content">
        <div class="target-text">Target: <span class="target-highlight">71-73kg @ 12-14% BF</span> by March 30</div>
      </div>
    </footer>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // =====================================================
    // FIREBASE CONFIG
    // =====================================================
    const firebaseConfig = {
      apiKey: "AIzaSyC5KsRYObEKpaSIwuyK4G7651_xeog5g6A",
      authDomain: "retrieve-57235.firebaseapp.com",
      databaseURL: "https://retrieve-57235-default-rtdb.firebaseio.com",
      projectId: "retrieve-57235",
      storageBucket: "retrieve-57235.firebasestorage.app",
      messagingSenderId: "47560739436",
      appId: "1:47560739436:web:6fc18d272139327834a649"
    };
    // =====================================================

    let db;
    let isOnline = navigator.onLine;
    let dataLoaded = false;
    let isSaving = false;
    let pendingUpdates = {};
    let saveTimeouts = {};
    let ignoreNextUpdate = {};

    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
    } catch (e) {
      console.error('Firebase init error:', e);
    }

    // State
    let state = {
      currentDate: new Date(),
      entries: {},
      lifts: {},
      weekly: {},
      measurements: {},
      activeTab: 'daily'
    };

    // =====================================================
    // UTILITIES
    // =====================================================
    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    function getWeekNumber(date) {
      const start = new Date(2026, 0, 6); // Jan 6, 2026 - Monday
      const diff = Math.floor((date - start) / (7 * 24 * 60 * 60 * 1000));
      return Math.max(1, Math.min(12, diff + 1));
    }

    function getDayName(date) {
      return ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'][date.getDay()];
    }

    function getMonthName(date) {
      return date.toLocaleString('en', { month: 'short' });
    }

    // NEW SCHEDULE: Upper A ‚Üí Run ‚Üí Lower A ‚Üí Run ‚Üí Upper B + Run ‚Üí Lower B ‚Üí Rest
    function getScheduledSession(date) {
      const day = date.getDay();
      const sessions = {
        0: 'REST',           // Sunday
        1: 'Upper A',        // Monday
        2: 'Running',        // Tuesday
        3: 'Lower A',        // Wednesday
        4: 'Running',        // Thursday
        5: 'Upper B + Run',  // Friday
        6: 'Lower B'         // Saturday
      };
      return sessions[day];
    }

    function isRunningDay(date) {
      const day = date.getDay();
      // Tuesday (2), Thursday (4), Friday (5 - Upper B + Run)
      return day === 2 || day === 4 || day === 5;
    }

    function calculatePace(distance, time) {
      if (!distance || !time || distance <= 0) return '‚Äî min/km';
      const pace = time / distance;
      const mins = Math.floor(pace);
      const secs = Math.round((pace - mins) * 60);
      return `${mins}:${secs.toString().padStart(2, '0')} min/km`;
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + type + ' show';
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    function updateSyncIndicator(status) {
      const indicator = document.getElementById('syncIndicator');
      const dot = document.getElementById('syncDot');
      const text = document.getElementById('syncText');
      
      indicator.className = 'sync-indicator ' + status;
      dot.className = status === 'syncing' ? 'dot pulse' : 'dot';
      
      const statusText = {
        syncing: 'Syncing...',
        synced: 'Synced',
        offline: 'Offline',
        error: 'Error'
      };
      text.textContent = statusText[status] || 'Synced';
    }

    function updateConnectionBanner() {
      const banner = document.getElementById('connectionBanner');
      banner.classList.toggle('show', !isOnline);
    }

    // =====================================================
    // FIREBASE OPERATIONS - WITH FIX FOR RACE CONDITION
    // =====================================================
    function saveToFirebase(path, data, key) {
      if (!db) return Promise.reject('No database');
      
      updateSyncIndicator('syncing');
      
      // Mark that we should ignore the next update for this key
      ignoreNextUpdate[key] = true;
      
      return db.ref(path).set(data)
        .then(() => {
          updateSyncIndicator('synced');
          // Clear the ignore flag after a short delay
          setTimeout(() => {
            ignoreNextUpdate[key] = false;
          }, 1000);
        })
        .catch(err => {
          console.error('Save error:', err);
          updateSyncIndicator('error');
          ignoreNextUpdate[key] = false;
          saveToLocal();
        });
    }

    function saveToLocal() {
      try {
        localStorage.setItem('retrieve_backup', JSON.stringify({
          entries: state.entries,
          lifts: state.lifts,
          weekly: state.weekly,
          measurements: state.measurements
        }));
      } catch (e) {
        console.error('Local save error:', e);
      }
    }

    function loadFromLocal() {
      try {
        const data = localStorage.getItem('retrieve_backup');
        if (data) {
          const parsed = JSON.parse(data);
          state.entries = parsed.entries || {};
          state.lifts = parsed.lifts || {};
          state.weekly = parsed.weekly || {};
          state.measurements = parsed.measurements || {};
          return true;
        }
      } catch (e) {
        console.error('Local load error:', e);
      }
      return false;
    }

    function loadAllData() {
      if (!db) {
        loadFromLocal();
        return Promise.resolve();
      }

      document.getElementById('loadingText').textContent = 'Loading data...';

      return db.ref('/').once('value')
        .then(snapshot => {
          const data = snapshot.val() || {};
          state.entries = data.entries || {};
          state.lifts = data.lifts || {};
          state.weekly = data.weekly || {};
          state.measurements = data.measurements || {};
          saveToLocal();
          dataLoaded = true;
        })
        .catch(err => {
          console.error('Load error:', err);
          loadFromLocal();
          dataLoaded = true;
        });
    }

    function setupRealtimeListeners() {
      if (!db) return;

      db.ref('entries').on('value', snapshot => {
        if (!dataLoaded) return;
        const key = 'entries';
        if (ignoreNextUpdate[key]) return;
        
        state.entries = snapshot.val() || {};
        if (state.activeTab === 'daily') {
          renderDailyTab();
        }
      });

      db.ref('lifts').on('value', snapshot => {
        if (!dataLoaded) return;
        const key = 'lifts';
        if (ignoreNextUpdate[key]) return;
        
        state.lifts = snapshot.val() || {};
        if (state.activeTab === 'lifts') {
          renderLiftsTab();
        }
      });

      db.ref('weekly').on('value', snapshot => {
        if (!dataLoaded) return;
        const key = 'weekly';
        if (ignoreNextUpdate[key]) return;
        
        state.weekly = snapshot.val() || {};
        if (state.activeTab === 'weekly') {
          renderWeeklyTab();
        }
      });

      db.ref('measurements').on('value', snapshot => {
        if (!dataLoaded) return;
        const key = 'measurements';
        if (ignoreNextUpdate[key]) return;
        
        state.measurements = snapshot.val() || {};
        if (state.activeTab === 'body') {
          renderBodyTab();
        }
      });
    }

    // =====================================================
    // DATA ACCESSORS - WITH DEBOUNCED SAVE
    // =====================================================
    function getCurrentEntry() {
      const key = formatDate(state.currentDate);
      return state.entries[key] || {};
    }

    function updateCurrentEntry(field, value) {
      const dateKey = formatDate(state.currentDate);
      if (!state.entries[dateKey]) state.entries[dateKey] = { date: dateKey };
      
      if (value === '' || value === null || value === undefined) {
        delete state.entries[dateKey][field];
      } else {
        state.entries[dateKey][field] = value;
      }
      
      // Debounced save
      if (saveTimeouts['entry_' + dateKey]) {
        clearTimeout(saveTimeouts['entry_' + dateKey]);
      }
      
      saveTimeouts['entry_' + dateKey] = setTimeout(() => {
        saveToFirebase('entries/' + dateKey, state.entries[dateKey], 'entries');
        saveToLocal();
      }, 800);
    }

    function getCurrentLifts() {
      const week = getWeekNumber(state.currentDate);
      return state.lifts[week] || {};
    }

    function updateCurrentLifts(field, value) {
      const week = getWeekNumber(state.currentDate);
      if (!state.lifts[week]) state.lifts[week] = { week };
      
      if (value === '' || value === null || value === undefined) {
        delete state.lifts[week][field];
      } else {
        state.lifts[week][field] = value;
      }
      
      if (saveTimeouts['lifts_' + week]) {
        clearTimeout(saveTimeouts['lifts_' + week]);
      }
      
      saveTimeouts['lifts_' + week] = setTimeout(() => {
        saveToFirebase('lifts/' + week, state.lifts[week], 'lifts');
        saveToLocal();
      }, 800);
    }

    function getCurrentWeekly() {
      const week = getWeekNumber(state.currentDate);
      return state.weekly[week] || {};
    }

    function updateCurrentWeekly(field, value) {
      const week = getWeekNumber(state.currentDate);
      if (!state.weekly[week]) state.weekly[week] = { week };
      
      if (value === '' || value === null || value === undefined) {
        delete state.weekly[week][field];
      } else {
        state.weekly[week][field] = value;
      }
      
      if (saveTimeouts['weekly_' + week]) {
        clearTimeout(saveTimeouts['weekly_' + week]);
      }
      
      saveTimeouts['weekly_' + week] = setTimeout(() => {
        saveToFirebase('weekly/' + week, state.weekly[week], 'weekly');
        saveToLocal();
      }, 800);
    }

    function getCurrentMeasurements() {
      const month = getMonthName(state.currentDate);
      return state.measurements[month] || {};
    }

    function updateCurrentMeasurements(field, value) {
      const month = getMonthName(state.currentDate);
      if (!state.measurements[month]) state.measurements[month] = { month };
      
      if (value === '' || value === null || value === undefined) {
        delete state.measurements[month][field];
      } else {
        state.measurements[month][field] = value;
      }
      
      if (saveTimeouts['measurements_' + month]) {
        clearTimeout(saveTimeouts['measurements_' + month]);
      }
      
      saveTimeouts['measurements_' + month] = setTimeout(() => {
        saveToFirebase('measurements/' + month, state.measurements[month], 'measurements');
        saveToLocal();
      }, 800);
    }

    // =====================================================
    // UI RENDERING - FIXED TO NOT CLEAR FOCUSED INPUT
    // =====================================================
    function renderDateNav() {
      const date = state.currentDate;
      const dayName = getDayName(date);
      const monthDay = date.toLocaleDateString('en', { month: 'short', day: 'numeric' });
      const week = getWeekNumber(date);
      const session = getScheduledSession(date);

      document.getElementById('dateMain').textContent = `${dayName} ‚Äî ${monthDay}`;
      document.getElementById('dateSub').textContent = `Week ${week}`;
      document.getElementById('sessionBadge').textContent = session;
      document.getElementById('liftsWeek').textContent = week;
      document.getElementById('weeklyWeek').textContent = week;
      document.getElementById('bodyMonth').textContent = getMonthName(date);
    }

    function updateInputIfNotFocused(id, value) {
      const input = document.getElementById(id);
      if (input && document.activeElement !== input) {
        input.value = value || '';
      }
    }

    function renderRatingButtons(containerId, currentValue, onSelect, isBlue = false) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      
      for (let i = 1; i <= 10; i++) {
        const btn = document.createElement('button');
        btn.className = 'rating-btn' + (currentValue === i ? (isBlue ? ' active-blue' : ' active') : '');
        btn.textContent = i;
        btn.onclick = () => onSelect(i);
        container.appendChild(btn);
      }
    }

    function renderSessionsButtons(currentValue) {
      const container = document.getElementById('sessionsGroup');
      container.innerHTML = '';
      
      for (let i = 0; i <= 6; i++) {
        const btn = document.createElement('button');
        btn.className = 'session-btn' + (currentValue === i ? ' active' : '');
        btn.textContent = i;
        btn.onclick = () => {
          updateCurrentWeekly('sessionsCompleted', i);
          renderWeeklyTab();
        };
        container.appendChild(btn);
      }
    }

    function renderDailyTab() {
      const entry = getCurrentEntry();
      
      // Only update inputs that aren't focused
      updateInputIfNotFocused('weight', entry.weight);
      updateInputIfNotFocused('protein', entry.protein);
      updateInputIfNotFocused('water', entry.water);
      updateInputIfNotFocused('sleep', entry.sleep);
      updateInputIfNotFocused('notes', entry.notes);

      // Running card - show on running days
      const runningCard = document.getElementById('runningCard');
      if (isRunningDay(state.currentDate)) {
        runningCard.style.display = 'block';
        updateInputIfNotFocused('runDistance', entry.runDistance);
        updateInputIfNotFocused('runTime', entry.runTime);
        
        // Update pace
        const pace = calculatePace(entry.runDistance, entry.runTime);
        document.getElementById('runPace').textContent = pace;
      } else {
        runningCard.style.display = 'none';
      }

      const yesBtn = document.getElementById('sessionYes');
      const noBtn = document.getElementById('sessionNo');
      yesBtn.className = 'toggle-btn' + (entry.sessionCompleted === true ? ' active-yes' : '');
      noBtn.className = 'toggle-btn' + (entry.sessionCompleted === false ? ' active-no' : '');

      renderRatingButtons('nutritionRating', entry.nutrition, (val) => {
        updateCurrentEntry('nutrition', val);
      });
      
      renderRatingButtons('energyRating', entry.energy, (val) => {
        updateCurrentEntry('energy', val);
      }, true);
    }

    function renderLiftsTab() {
      const lifts = getCurrentLifts();
      updateInputIfNotFocused('lift-incline', lifts.incline);
      updateInputIfNotFocused('lift-ohp', lifts.ohp);
      updateInputIfNotFocused('lift-pullups', lifts.pullups);
      updateInputIfNotFocused('lift-row', lifts.row);
      updateInputIfNotFocused('lift-squat', lifts.squat);
      updateInputIfNotFocused('lift-rdl', lifts.rdl);
    }

    function renderWeeklyTab() {
      const weekly = getCurrentWeekly();
      updateInputIfNotFocused('weekStartWeight', weekly.startWeight);
      updateInputIfNotFocused('weekEndWeight', weekly.endWeight);
      updateInputIfNotFocused('weekAvgSleep', weekly.avgSleep);
      updateInputIfNotFocused('weekNotes', weekly.notes);
      renderSessionsButtons(weekly.sessionsCompleted);
    }

    function renderBodyTab() {
      const meas = getCurrentMeasurements();
      updateInputIfNotFocused('bodyWeight', meas.weight);
      updateInputIfNotFocused('bodyWaist', meas.waist);
      updateInputIfNotFocused('bodyShoulders', meas.shoulders);
      updateInputIfNotFocused('bodyChest', meas.chest);
      updateInputIfNotFocused('bodyArmL', meas.armL);
      updateInputIfNotFocused('bodyArmR', meas.armR);
    }

    function renderCurrentTab() {
      if (state.activeTab === 'daily') renderDailyTab();
      else if (state.activeTab === 'lifts') renderLiftsTab();
      else if (state.activeTab === 'weekly') renderWeeklyTab();
      else if (state.activeTab === 'body') renderBodyTab();
    }

    function switchTab(tabName) {
      state.activeTab = tabName;
      
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });
      
      document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
      });
      document.getElementById(tabName + '-tab').style.display = 'block';
      
      renderCurrentTab();
    }

    // =====================================================
    // REPORT GENERATION
    // =====================================================
    function generateReport() {
      const week = getWeekNumber(state.currentDate);
      const weekEntries = Object.values(state.entries).filter(e => {
        if (!e || !e.date) return false;
        const entryDate = new Date(e.date);
        return getWeekNumber(entryDate) === week;
      }).sort((a, b) => a.date.localeCompare(b.date));

      const lifts = state.lifts[week] || {};
      const weekly = state.weekly[week] || {};

      const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>RETRIEVE Week ${week} Report</title>
  <style>
    body { font-family: -apple-system, sans-serif; padding: 30px; max-width: 800px; margin: 0 auto; }
    h1 { color: #0f172a; border-bottom: 3px solid #10b981; padding-bottom: 15px; }
    h2 { color: #1e293b; margin-top: 30px; }
    .meta { color: #64748b; margin-bottom: 30px; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th { background: #0f172a; color: white; padding: 12px; text-align: left; }
    td { padding: 10px 12px; border-bottom: 1px solid #e2e8f0; }
    tr:nth-child(even) { background: #f8fafc; }
    .summary { background: #f0fdf4; border-left: 4px solid #10b981; padding: 20px; margin: 20px 0; }
    .summary li { margin: 8px 0; }
    .note { background: #fefce8; border-left: 4px solid #f59e0b; padding: 15px; margin-top: 30px; }
    .check { color: #10b981; }
    .cross { color: #ef4444; }
  </style>
</head>
<body>
  <h1>RETRIEVE ‚Äî Week ${week} Report</h1>
  <p class="meta">Generated: ${new Date().toLocaleString()}</p>

  <h2>üìÖ Daily Entries</h2>
  <table>
    <tr>
      <th>Date</th>
      <th>Weight</th>
      <th>Session</th>
      <th>Protein</th>
      <th>Water</th>
      <th>Sleep</th>
      <th>Nutr</th>
      <th>Energy</th>
      <th>Run</th>
    </tr>
    ${weekEntries.map(e => `
    <tr>
      <td>${e.date}</td>
      <td>${e.weight || '‚Äî'} kg</td>
      <td>${e.sessionCompleted === true ? '<span class="check">‚úì</span>' : e.sessionCompleted === false ? '<span class="cross">‚úó</span>' : '‚Äî'}</td>
      <td>${e.protein || '‚Äî'}g</td>
      <td>${e.water || '‚Äî'}L</td>
      <td>${e.sleep || '‚Äî'}h</td>
      <td>${e.nutrition || '‚Äî'}/10</td>
      <td>${e.energy || '‚Äî'}/10</td>
      <td>${e.runTime ? (e.runDistance ? e.runDistance + 'km / ' : '') + e.runTime + 'min' : '‚Äî'}</td>
    </tr>`).join('')}
  </table>

  <h2>üèãÔ∏è Key Lifts</h2>
  <table>
    <tr>
      <th>Incline Bench</th>
      <th>Shoulder Press</th>
      <th>Pull-ups</th>
      <th>BB Row</th>
      <th>Squat</th>
      <th>RDL</th>
    </tr>
    <tr>
      <td>${lifts.incline || '‚Äî'}</td>
      <td>${lifts.ohp || '‚Äî'}</td>
      <td>${lifts.pullups || '‚Äî'}</td>
      <td>${lifts.row || '‚Äî'}</td>
      <td>${lifts.squat || '‚Äî'}</td>
      <td>${lifts.rdl || '‚Äî'}</td>
    </tr>
  </table>

  <h2>üìä Weekly Summary</h2>
  <div class="summary">
    <ul>
      <li><strong>Sessions Completed:</strong> ${weekly.sessionsCompleted ?? '‚Äî'}/6</li>
      <li><strong>Start Weight:</strong> ${weekly.startWeight || '‚Äî'} kg</li>
      <li><strong>End Weight:</strong> ${weekly.endWeight || '‚Äî'} kg</li>
      <li><strong>Avg Sleep:</strong> ${weekly.avgSleep || '‚Äî'} hours</li>
    </ul>
  </div>

  ${weekly.notes ? `<h2>üìù Notes</h2><p>${weekly.notes}</p>` : ''}

  <div class="note">
    <strong>For Retrieve:</strong> Send this report to Claude for analysis and system adjustments.
  </div>
</body>
</html>`;

      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `RETRIEVE_Week${week}_Report.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('Report downloaded!', 'success');
    }

    // =====================================================
    // EVENT LISTENERS
    // =====================================================
    function setupEventListeners() {
      document.getElementById('prevDay').onclick = () => {
        state.currentDate = new Date(state.currentDate.getTime() - 24 * 60 * 60 * 1000);
        renderDateNav();
        renderCurrentTab();
      };

      document.getElementById('nextDay').onclick = () => {
        state.currentDate = new Date(state.currentDate.getTime() + 24 * 60 * 60 * 1000);
        renderDateNav();
        renderCurrentTab();
      };

      document.querySelectorAll('.tab').forEach(tab => {
        tab.onclick = () => switchTab(tab.dataset.tab);
      });

      // Daily inputs - using onchange for more reliable saves
      const weightInput = document.getElementById('weight');
      weightInput.oninput = (e) => updateCurrentEntry('weight', e.target.value ? parseFloat(e.target.value) : null);
      
      const proteinInput = document.getElementById('protein');
      proteinInput.oninput = (e) => updateCurrentEntry('protein', e.target.value ? parseInt(e.target.value) : null);
      
      const waterInput = document.getElementById('water');
      waterInput.oninput = (e) => updateCurrentEntry('water', e.target.value ? parseFloat(e.target.value) : null);
      
      const sleepInput = document.getElementById('sleep');
      sleepInput.oninput = (e) => updateCurrentEntry('sleep', e.target.value ? parseFloat(e.target.value) : null);
      
      const notesInput = document.getElementById('notes');
      notesInput.oninput = (e) => updateCurrentEntry('notes', e.target.value || null);

      document.getElementById('sessionYes').onclick = () => {
        updateCurrentEntry('sessionCompleted', true);
        renderDailyTab();
      };
      document.getElementById('sessionNo').onclick = () => {
        updateCurrentEntry('sessionCompleted', false);
        renderDailyTab();
      };

      // Running inputs
      document.getElementById('runDistance').oninput = (e) => {
        const val = e.target.value ? parseFloat(e.target.value) : null;
        updateCurrentEntry('runDistance', val);
        // Update pace display
        const entry = getCurrentEntry();
        const pace = calculatePace(val, entry.runTime);
        document.getElementById('runPace').textContent = pace;
      };
      
      document.getElementById('runTime').oninput = (e) => {
        const val = e.target.value ? parseInt(e.target.value) : null;
        updateCurrentEntry('runTime', val);
        // Update pace display
        const entry = getCurrentEntry();
        const pace = calculatePace(entry.runDistance, val);
        document.getElementById('runPace').textContent = pace;
      };

      // Lifts inputs
      document.getElementById('lift-incline').oninput = (e) => updateCurrentLifts('incline', e.target.value || null);
      document.getElementById('lift-ohp').oninput = (e) => updateCurrentLifts('ohp', e.target.value || null);
      document.getElementById('lift-pullups').oninput = (e) => updateCurrentLifts('pullups', e.target.value || null);
      document.getElementById('lift-row').oninput = (e) => updateCurrentLifts('row', e.target.value || null);
      document.getElementById('lift-squat').oninput = (e) => updateCurrentLifts('squat', e.target.value || null);
      document.getElementById('lift-rdl').oninput = (e) => updateCurrentLifts('rdl', e.target.value || null);

      // Weekly inputs
      document.getElementById('weekStartWeight').oninput = (e) => updateCurrentWeekly('startWeight', e.target.value ? parseFloat(e.target.value) : null);
      document.getElementById('weekEndWeight').oninput = (e) => updateCurrentWeekly('endWeight', e.target.value ? parseFloat(e.target.value) : null);
      document.getElementById('weekAvgSleep').oninput = (e) => updateCurrentWeekly('avgSleep', e.target.value ? parseFloat(e.target.value) : null);
      document.getElementById('weekNotes').oninput = (e) => updateCurrentWeekly('notes', e.target.value || null);

      // Body inputs
      document.getElementById('bodyWeight').oninput = (e) => updateCurrentMeasurements('weight', e.target.value ? parseFloat(e.target.value) : null);
      document.getElementById('bodyWaist').oninput = (e) => updateCurrentMeasurements('waist', e.target.value ? parseFloat(e.target.value) : null);
      document.getElementById('bodyShoulders').oninput = (e) => updateCurrentMeasurements('shoulders', e.target.value ? parseFloat(e.target.value) : null);
      document.getElementById('bodyChest').oninput = (e) => updateCurrentMeasurements('chest', e.target.value ? parseFloat(e.target.value) : null);
      document.getElementById('bodyArmL').oninput = (e) => updateCurrentMeasurements('armL', e.target.value ? parseFloat(e.target.value) : null);
      document.getElementById('bodyArmR').oninput = (e) => updateCurrentMeasurements('armR', e.target.value ? parseFloat(e.target.value) : null);

      document.getElementById('downloadReport').onclick = generateReport;

      window.addEventListener('online', () => {
        isOnline = true;
        updateSyncIndicator('synced');
        updateConnectionBanner();
      });

      window.addEventListener('offline', () => {
        isOnline = false;
        updateSyncIndicator('offline');
        updateConnectionBanner();
      });
    }

    // =====================================================
    // INITIALIZATION
    // =====================================================
    async function init() {
      try {
        await loadAllData();
        setupRealtimeListeners();
        setupEventListeners();
        renderDateNav();
        renderDailyTab();
        
        updateSyncIndicator(isOnline ? 'synced' : 'offline');
        updateConnectionBanner();

        setTimeout(() => {
          document.getElementById('loadingScreen').style.display = 'none';
          document.getElementById('appContent').classList.add('loaded');
        }, 500);
      } catch (e) {
        console.error('Init error:', e);
        document.getElementById('loadingText').textContent = 'Error loading app. Refresh to retry.';
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
